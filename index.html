<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>EarthVie</title>
    <link href="style.css" rel="stylesheet">
</head>
<body>
<div id="left-sidebar">
    <div class="sidebar-item active" data-panel="layers">
        <span class="icon">üó∫Ô∏è</span><span class="label">Layers</span>
    </div>
    <div class="sidebar-item" data-panel="settings">
        <span class="icon">‚öôÔ∏è</span><span class="label">Settings</span>
    </div>
    <div class="sidebar-item" data-panel="about">
        <span class="icon">‚ÑπÔ∏è</span><span class="label">About</span>
    </div>
</div>
<div id="sidebar-content">
    <div class="sidebar-content-panel visible" id="panel-layers">
        <div class="panel-header">
            <h3>Layers</h3>
            <button class="hide-panel-button">&times;</button>
        </div>
        <div class="panel-inner-content">
            <h4>Map Layers</h4>
            <ul class="layer-list">
                <li><input checked id="toggle-layer-airports" type="checkbox"><label for="toggle-layer-airports">Airports</label>
                </li>
                <li><input checked id="toggle-layer-waypoints" type="checkbox"><label for="toggle-layer-waypoints">Waypoints</label>
                </li>
                <li><input checked id="toggle-layer-navaids" type="checkbox"><label
                        for="toggle-layer-navaids">Navaids</label></li>
                <li><input checked id="toggle-magvar-overlay" type="checkbox"><label for="toggle-magvar-overlay">Magnetic
                    Variation</label></li>
            </ul>
            <div class="control-group">
                <label for="magvar-resolution">Magnetic Variation Resolution:</label>
                <input type="range" id="magvar-resolution" min="5" max="30" value="15" step="5">
                <span class="resolution-value">15¬∞</span>
            </div>
        </div>
    </div>
    <div class="sidebar-content-panel" id="panel-settings">
        <div class="panel-header">
            <h3>Settings</h3>
            <button class="hide-panel-button">&times;</button>
        </div>
        <div class="panel-inner-content">
            <h4>Display</h4>
            <label><input checked id="enable-dark-mode" type="checkbox">Dark Mode</label>
            <label><input id="enable-high-contrast" type="checkbox">High Contrast</label>
            <h4>Preferences</h4>
            <label><input checked id="show-capitals" type="checkbox">Show Capitals</label>
        </div>
    </div>
    <div class="sidebar-content-panel" id="panel-about">
        <div class="panel-header">
            <h3>About</h3>
            <button class="hide-panel-button">&times;</button>
        </div>
        <div class="panel-inner-content">
            <h4>EarthView Globe</h4>
            <p>Modern interactive globe visualization.<br>
                Data source: <span id="data-source-info">N/A</span><br>
                Timestamp: <span id="data-source-timestamp">N/A</span></p>
        </div>
    </div>
</div>
<div id="globe-container"></div>
<!--          <footer id="footer-info">-->
<!--            &copy; 2023 EarthVie &mdash; <a href="#">Support</a> &middot; <a href="#">Terms</a> &middot; <a href="#">Privacy</a>-->
<!--          </footer>-->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script type="module">
    import {setupSvgGlobe} from './js/svg-globe-cambecc.js';

    const sidebarItems = document.querySelectorAll('.sidebar-item');
    const panels = {
        layers: document.getElementById('panel-layers'),
        settings: document.getElementById('panel-settings'),
        about: document.getElementById('panel-about')
    };

    function adjustGlobeContainerSize() {
        const globeContainer = document.getElementById('globe-container');
        const sidebarContent = document.getElementById('sidebar-content');
        const sidebarVisible = document.body.classList.contains('panel-visible');
        let availableWidth = window.innerWidth;  // Start with full window width
        let sidebarWidth = 0; // Initialize sidebarWidth

        if (sidebarVisible) {
            sidebarWidth = sidebarContent.offsetWidth; // Get sidebar width if visible
            availableWidth -= sidebarWidth; // Subtract sidebar width if visible
        }

        // Apply styles *before* the class change for the panel
        sidebarContent.style.transform = sidebarVisible ? `translateX(0)` : `translateX(-${sidebarWidth}px)`;

        globeContainer.style.width = `${availableWidth}px`;
        globeContainer.style.height = `${window.innerHeight}px`; // Occupy full window height

        // Reset margins, just in case:
        globeContainer.style.marginLeft = '0';
        globeContainer.style.marginTop = '0';
    }

    sidebarItems.forEach(item => {
        item.addEventListener('click', () => {
            document.querySelector('.sidebar-item.active')?.classList.remove('active');
            item.classList.add('active');

            // Remove 'visible' class from all panels *before* animating
            Object.values(panels).forEach(p => p.classList.remove('visible'));
            document.body.classList.add('panel-visible'); // Add class before calling adjust size
            adjustGlobeContainerSize();

            // Add 'visible' class to the target panel *after* starting the animation
            panels[item.dataset.panel]?.classList.add('visible');
        });
    });

    document.querySelectorAll('.hide-panel-button').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove 'visible' class from all panels *before* animating
            Object.values(panels).forEach(p => p.classList.remove('visible'));

            document.body.classList.remove('panel-visible'); // Remove class before calling adjust size
            adjustGlobeContainerSize();
        });
    });

    sidebarItems.forEach(item => {
        item.addEventListener('click', () => {
            document.querySelector('.sidebar-item.active')?.classList.remove('active');
            item.classList.add('active');
            Object.values(panels).forEach(p => p.classList.remove('visible'));
            panels[item.dataset.panel]?.classList.add('visible');
            document.body.classList.add('panel-visible');
            adjustGlobeContainerSize(); // Add this line
        });
    });

    document.querySelectorAll('.hide-panel-button').forEach(btn => {
        btn.addEventListener('click', () => {
            Object.values(panels).forEach(p => p.classList.remove('visible'));
            document.body.classList.remove('panel-visible');
            adjustGlobeContainerSize(); // Add this line
        });
    });

    // Also adjust on window resize
    window.addEventListener('resize', adjustGlobeContainerSize);

    // Call once on initial load
    document.addEventListener('DOMContentLoaded', adjustGlobeContainerSize);

    fetch("./MagVar3D_v3/ne_110m_land.geojson")
        .then(res => res.json())
        .then(landData => {
            const globeContainer = document.getElementById("globe-container");
            const width = globeContainer.offsetWidth;
            const height = globeContainer.offsetHeight;
            setupSvgGlobe(globeContainer, landData, {width: width, height: height});
        });

</script>
</body>
</html>